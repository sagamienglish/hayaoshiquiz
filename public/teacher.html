<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Quiz Teacher Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        h1 { font-family: 'Fredoka One', cursive; font-size: 3rem; text-align: center; color: #ff6b6b; text-shadow: 2px 2px 0px #ffe6e6; margin: 0; padding: 0;}
        
        #lobby { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .settings-group { margin-bottom: 15px; font-size: 1.2rem; background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center;}
        .settings-group input { width: 60px; padding: 8px; font-size: 1.2rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; font-weight: bold;}
        .user-badge { display: inline-block; background: #007bff; color: white; padding: 8px 15px; border-radius: 20px; margin: 5px; font-weight: bold; font-size: 1.1rem; }
        
        .qr-section { text-align: center; margin: 25px 0; padding: 15px; background: #e9ecef; border-radius: 10px; }
        .qr-section img { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; }
        
        /* ãƒˆãƒƒãƒ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ï¼ˆæ–‡å­—ã‚’å°ã•ãã€å…¥åŠ›å¯èƒ½ã«ï¼‰ */
        .header-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; background: #fff; padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .score-settings-inline { font-size: 0.85rem; color: #555; display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; font-weight: bold;}
        .score-settings-inline input { width: 40px; padding: 3px; font-size: 0.85rem; text-align: center; border: 1px solid #ccc; border-radius: 3px; font-weight: bold; background: white;}
        
        /* Top 5 è¡¨ç¤º */
        #current-leaders { font-size: 0.9rem; color: #444; text-align: right; line-height: 1.4; font-weight: bold;}
        .leader-title { font-size: 1rem; color: #000; margin-bottom: 5px; border-bottom: 2px solid #ccc; text-align: right;}

        .controls { text-align: center; margin-bottom: 20px; }
        button { font-family: 'Fredoka One', cursive; font-size: 1.2rem; padding: 10px 20px; margin: 0 5px; border: none; border-radius: 8px; cursor: pointer; color: white; transition: transform 0.1s, opacity 0.2s; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }
        button:active { transform: translateY(0); }
        .btn-start { background-color: #4CAF50; font-size: 1.5rem; width: 100%; margin-top: 20px; padding: 15px; }
        .btn-reveal { background-color: #9c27b0; }
        .btn-reset { background-color: #6c757d; }
        .btn-next { background-color: #007bff; }
        .btn-finish { background-color: #343a40; display: block; margin: 40px auto; font-size: 1.5rem; }

        .container { display: flex; justify-content: space-around; gap: 10px; }
        .choice-box { flex: 1; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .choice-header { padding: 20px 0; text-align: center; color: white; font-size: 2.5rem; font-family: 'Fredoka One', cursive; cursor: pointer; position: relative;}
        .choice-header:hover::after { content: 'æ­£è§£ã«ã™ã‚‹'; position: absolute; top: 10px; right: 10px; font-size: 1rem; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-family: 'Noto Sans JP', sans-serif;}
        .bg-A { background-color: #e63946; }
        .bg-B { background-color: #2a9d8f; }
        .bg-C { background-color: #e9c46a; }
        .bg-D { background-color: #264653; }
        ol { padding-left: 20px; margin: 15px; font-size: 1.2rem; font-weight: bold; min-height: 100px;}
        li { margin-bottom: 8px; border-bottom: 1px dashed #ddd; }

        /* æ•™å“¡ç”»é¢ã®æ­£è§£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        #correct-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .correct-text { color: #ffeb3b; font-size: 7rem; font-family: 'Fredoka One', cursive; text-shadow: 4px 4px 0px #ff9800; animation: popZoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .correct-close { margin-top: 40px; font-size: 1.5rem; padding: 15px 40px; background: white; color: black; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0px #ccc; }
        @keyframes popZoom {
            0% { transform: scale(0.1) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        #results { text-align: center; }
        .rank-item { background: white; margin: 10px auto; width: 80%; max-width: 500px; padding: 20px; border-radius: 10px; font-size: 1.5rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(50px); animation: popIn 0.5s forwards; }
        .rank-1 { font-size: 2.5rem; color: #d4af37; background: #fffdf0; border: 3px solid #d4af37;}
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="lobby">
        <h1>Quiz è¨­å®š</h1>
        <div class="settings-group">
            <span>â­• æ­£è§£ã—ãŸæ™‚ã®åŸºæœ¬ç‚¹æ•°:</span>
            <span><input type="number" id="setting-base" value="10"> ç‚¹</span>
        </div>
        <div class="settings-group">
            <span>âš¡ æ—©ãç­”ãˆãŸ <input type="number" id="setting-count" value="1"> äººã«ã¯:</span>
            <span>+<input type="number" id="setting-bonus" value="5"> ç‚¹</span>
        </div>

        <div class="qr-section">
            <p style="font-weight: bold; margin: 0;">ğŸ‘‡ ç”Ÿå¾’ç”¨ å‚åŠ QRã‚³ãƒ¼ãƒ‰ ğŸ‘‡</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://hayaoshiquiz.onrender.com/student.html" alt="QR Code">
            <p style="font-size: 0.9rem; margin-top: 5px; color: #666;">https://hayaoshiquiz.onrender.com/student.html</p>
        </div>
        
        <h3 style="text-align: center; margin-top: 20px;">å‚åŠ ä¸­ã®ç”Ÿå¾’</h3>
        <div id="joined-users" style="text-align: center;">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“...</div>
        
        <button class="btn-start" onclick="startQuiz()">ã‚¯ã‚¤ã‚ºã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="quiz-screen" style="display: none;">
        <div class="header-info">
            <div class="score-settings-inline">
                ğŸ’¡ ä»Šå›ã®æ­£è§£: <input type="number" id="inline-base">ç‚¹<br>
                (å…ˆç€ <input type="number" id="inline-count">åã« +<input type="number" id="inline-bonus">ç‚¹)
            </div>
            <h1>Quiz</h1>
            <div>
                <div class="leader-title">ğŸ† Top 5</div>
                <div id="current-leaders">ã¾ã å¾—ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-reveal" onclick="revealNames()">ğŸ‘€ èª°ãŒæŠ¼ã—ãŸã‹è¦‹ã‚‹ (Reveal)</button>
            <button class="btn-reset" onclick="resetQuestion()">ğŸ”„ åŒã˜å•é¡Œã§ã‚„ã‚Šç›´ã— (Reset)</button>
            <button class="btn-next" onclick="nextQuestion()">â¡ï¸ æ¬¡ã®å•é¡Œã¸ (Next Question)</button>
        </div>
        
        <div class="container">
            <div class="choice-box">
                <div class="choice-header bg-A" onclick="judgeChoice('A')">A</div>
                <ol id="list-A"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-B" onclick="judgeChoice('B')">B</div>
                <ol id="list-B"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-C" onclick="judgeChoice('C')">C</div>
                <ol id="list-C"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-D" onclick="judgeChoice('D')">D</div>
                <ol id="list-D"></ol>
            </div>
        </div>

        <button class="btn-finish" onclick="finishQuiz()">ğŸ Finish this quiz</button>
    </div>

    <div id="correct-overlay">
        <div class="correct-text" id="correct-display-text">æ­£è§£ã¯ Aï¼</div>
        <button class="correct-close" onclick="closeOverlay()">ç”»é¢ã‚’æˆ»ã™</button>
    </div>

    <div id="results" style="display: none;">
        <h1>Final Results</h1>
        <div id="podium"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentAnswers = { A: [], B: [], C: [], D: [] };
        let isRevealed = false;
        let isJudged = false;
        let currentRanking = [];

        socket.on('update_lobby', (names) => {
            const list = document.getElementById('joined-users');
            list.innerHTML = '';
            names.forEach(name => {
                list.innerHTML += `<span class="user-badge">${name}</span>`;
            });
        });

        function startQuiz() {
            const base = document.getElementById('setting-base').value;
            const bonus = document.getElementById('setting-bonus').value;
            const count = document.getElementById('setting-count').value;
            
            socket.emit('update_settings', { basePoints: base, bonusPoints: bonus, bonusCount: count });
            
            // ã‚¯ã‚¤ã‚ºç”»é¢ã®å·¦ä¸Šã®å°ã•ãªå…¥åŠ›æ¬„ã«è¨­å®šå€¤ã‚’ç§»ã™
            document.getElementById('inline-base').value = base;
            document.getElementById('inline-bonus').value = bonus;
            document.getElementById('inline-count').value = count;
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
        }

        socket.on('update_answers_teacher', (answers) => {
            currentAnswers = answers;
            renderAnswers();
        });

        function renderAnswers() {
            ['A', 'B', 'C', 'D'].forEach(choice => {
                const list = document.getElementById(`list-${choice}`);
                list.innerHTML = '';
                currentAnswers[choice].forEach((name) => {
                    const li = document.createElement('li');
                    li.textContent = isRevealed ? name : 'ğŸ”’ (å›ç­”æ¸ˆ)';
                    li.style.color = isRevealed ? '#333' : '#aaa';
                    list.appendChild(li);
                });
            });
        }

        function revealNames() {
            isRevealed = true;
            renderAnswers();
        }

        function judgeChoice(choice) {
            if (isJudged) return; 
            if (!isRevealed) {
                alert('å…ˆã«ã€ŒğŸ‘€ èª°ãŒæŠ¼ã—ãŸã‹è¦‹ã‚‹ã€ã‚’æŠ¼ã—ã¦ã€åå‰ã‚’å…¬é–‹ã—ã¦ãã ã•ã„ï¼');
                return;
            }
            isJudged = true;
            
            // æ•™å“¡ç”»é¢ã®å·¦ä¸Šã®ã€Œç¾åœ¨ã®å…¥åŠ›å€¤ã€ã‚’å–å¾—ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
            const currentBase = document.getElementById('inline-base').value;
            const currentBonus = document.getElementById('inline-bonus').value;
            const currentCount = document.getElementById('inline-count').value;

            socket.emit('judge_answer', { 
                choice: choice, 
                currentSettings: { basePoints: currentBase, bonusPoints: currentBonus, bonusCount: currentCount } 
            });

            // æ´¾æ‰‹ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            const overlay = document.getElementById('correct-overlay');
            const text = document.getElementById('correct-display-text');
            text.textContent = `æ­£è§£ã¯ ${choice} ï¼ï¼`;
            overlay.style.display = 'flex';
        }

        function closeOverlay() {
            document.getElementById('correct-overlay').style.display = 'none';
        }

        function resetQuestion() {
            socket.emit('reset_question');
            isRevealed = false;
            isJudged = false;
        }

        function nextQuestion() {
            resetQuestion(); 
        }

        // ãƒˆãƒƒãƒ—5ã®è¡¨ç¤ºå‡¦ç†
        socket.on('update_ranking', (ranking) => {
            currentRanking = ranking;
            const leadersDiv = document.getElementById('current-leaders');
            leadersDiv.innerHTML = '';
            
            if (ranking.length === 0) {
                leadersDiv.innerHTML = 'ã¾ã å¾—ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“';
                return;
            }
            
            // æœ€å¤§5äººã¾ã§è¡¨ç¤º
            let limit = Math.min(ranking.length, 5);
            for(let i = 0; i < limit; i++) {
                leadersDiv.innerHTML += `<div>${i+1}ä½: ${ranking[i].name} (${ranking[i].score}ç‚¹)</div>`;
            }
        });

        function finishQuiz() {
            if(!confirm('ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¦çµæœç™ºè¡¨ã«ç§»ã‚Šã¾ã™ã‹ï¼Ÿ')) return;

            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            let top5 = currentRanking.slice(0, 5).reverse(); 
            let delay = 500; 
            
            if(top5.length === 0) {
                podium.innerHTML = '<h2>ã¾ã èª°ã‚‚å¾—ç‚¹ã—ã¦ã„ã¾ã›ã‚“...ï¼</h2>';
                return;
            }

            top5.forEach((player, index) => {
                setTimeout(() => {
                    let rank = top5.length - index;
                    let div = document.createElement('div');
                    div.className = 'rank-item';
                    if(rank === 1) div.classList.add('rank-1');
                    div.innerHTML = `ç¬¬ ${rank} ä½: ${player.name} <span style="color:#666; font-size:1rem;">(${player.score}ç‚¹)</span>`;
                    podium.prepend(div);
                }, delay);
                delay += 1000;
            });
        }
    </script>
</body>
</html>
