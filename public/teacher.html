<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Quiz Teacher Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        h1 { font-family: 'Fredoka One', cursive; font-size: 3rem; text-align: center; color: #ff6b6b; text-shadow: 2px 2px 0px #ffe6e6; margin: 0; padding: 0;}
        
        #lobby { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 15px rgba(0,0,0,0.1); text-align: center;}
        
        .btn-settings-top { font-size: 1.2rem; font-weight: bold; padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; margin-bottom: 20px; box-shadow: 0 4px 0px #495057;}
        .btn-settings-top:active { transform: translateY(4px); box-shadow: none; }

        .qr-section { text-align: center; margin: 25px 0; padding: 15px; background: #e9ecef; border-radius: 10px; }
        .qr-section img { border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 10px; }
        
        .header-info { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; background: #fff; padding: 10px 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .score-settings-inline { font-size: 0.85rem; color: #555; display: flex; align-items: center; gap: 5px; background: #f8f9fa; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd; font-weight: bold;}
        .score-settings-inline input { width: 40px; padding: 3px; font-size: 0.85rem; text-align: center; border: 1px solid #ccc; border-radius: 3px; font-weight: bold; background: white;}
        
        .question-box { background: white; margin-bottom: 20px; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border: 2px dashed #ccc;}
        .question-box h2 { font-size: 1.2rem; color: #007bff; margin: 0 0 10px 0;}
        .question-box h3 { font-size: 1.8rem; color: #333; margin: 0;}
        
        #current-leaders { font-size: 0.9rem; color: #444; text-align: right; line-height: 1.4; font-weight: bold;}
        .leader-title { font-size: 1rem; color: #000; margin-bottom: 5px; border-bottom: 2px solid #ccc; text-align: right;}

        .controls { text-align: center; margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;}
        button { font-family: 'Fredoka One', cursive, 'Noto Sans JP'; font-size: 1.2rem; padding: 10px 20px; margin: 0; border: none; border-radius: 8px; cursor: pointer; color: white; transition: transform 0.1s, opacity 0.2s; font-weight: bold;}
        button:hover { transform: translateY(-2px); opacity: 0.9; }
        button:active { transform: translateY(0); }
        .btn-start { background-color: #4CAF50; font-size: 1.5rem; width: 100%; margin-top: 20px; padding: 15px; box-shadow: 0 4px 0px #388E3C;}
        .btn-start:active { box-shadow: none; transform: translateY(4px); }
        .btn-reveal { background-color: #9c27b0; }
        .btn-reset { background-color: #6c757d; }
        .btn-judge { background-color: #ff9800; color: white; }
        .btn-next { background-color: #007bff; }
        .btn-finish { background-color: #343a40; display: block; margin: 40px auto; font-size: 1.5rem; }

        .container { display: flex; justify-content: space-around; gap: 10px; }
        .choice-box { flex: 1; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 8px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;}
        .choice-header { padding: 15px 0; text-align: center; color: white; font-size: 2rem; font-family: 'Fredoka One', cursive; cursor: pointer; position: relative;}
        .choice-header:hover::after { content: 'æ­£è§£ã«ã™ã‚‹'; position: absolute; top: 10px; right: 10px; font-size: 0.9rem; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-family: 'Noto Sans JP', sans-serif;}
        
        .choice-text { font-family: 'Noto Sans JP', sans-serif; font-size: 1rem; padding: 10px; text-align: center; font-weight: bold; color: #333; border-bottom: 2px solid #eee; background: #fafafa; min-height: 2.5em; display: flex; align-items: center; justify-content: center; word-break: break-all;}

        .bg-A { background-color: #e63946; }
        .bg-B { background-color: #2a9d8f; }
        .bg-C { background-color: #e9c46a; }
        .bg-D { background-color: #264653; }
        ol { padding-left: 20px; margin: 15px; font-size: 1.2rem; font-weight: bold; min-height: 100px; flex-grow: 1;}
        li { margin-bottom: 8px; border-bottom: 1px dashed #ddd; }

        #settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .settings-group { margin-bottom: 15px; font-size: 1.1rem; background: #f8f9fa; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold;}
        .settings-group input { width: 60px; padding: 8px; font-size: 1.1rem; text-align: center; border-radius: 5px; border: 1px solid #ccc; font-weight: bold;}
        .excel-group { flex-direction: column; align-items: flex-start; gap: 10px; }
        .excel-group textarea { width: 100%; font-size: 1rem; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-family: monospace; white-space: pre;}
        .btn-save { background-color: #4CAF50; width: 100%; font-size: 1.2rem; padding: 12px; margin-top: 10px; }

        #correct-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; }
        .correct-text { color: #ffeb3b; font-size: 7rem; font-family: 'Fredoka One', cursive; text-shadow: 4px 4px 0px #ff9800; animation: popZoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .correct-close { margin-top: 40px; font-size: 1.5rem; padding: 15px 40px; background: white; color: black; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 0px #ccc; }
        @keyframes popZoom {
            0% { transform: scale(0.1) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        #results { text-align: center; }
        .rank-item { background: white; margin: 10px auto; width: 80%; max-width: 500px; padding: 20px; border-radius: 10px; font-size: 1.5rem; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.1); opacity: 0; transform: translateY(50px); animation: popIn 0.5s forwards; }
        .rank-1 { font-size: 2.5rem; color: #d4af37; background: #fffdf0; border: 3px solid #d4af37;}
        @keyframes popIn { to { opacity: 1; transform: translateY(0); } }
        .user-badge { display: inline-block; background: #007bff; color: white; padding: 8px 15px; border-radius: 20px; margin: 5px; font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body>

    <audio id="audio-bgm" src="bgm.mp3" loop></audio>
    <audio id="audio-reveal" src="reveal.mp3" preload="auto"></audio>
    <audio id="audio-correct" src="correct.mp3" preload="auto"></audio>
    <audio id="audio-reset" src="reset.mp3" preload="auto"></audio>

    <div id="lobby">
        <h1>Quiz</h1>
        <br>
        <button class="btn-settings-top" onclick="openSettings()">âš™ï¸ ã‚¯ã‚¤ã‚ºè¨­å®šãƒ»å•é¡Œãƒ‡ãƒ¼ã‚¿å…¥åŠ›</button>

        <div class="qr-section">
            <p style="font-weight: bold; margin: 0;">ğŸ‘‡ ç”Ÿå¾’ç”¨ å‚åŠ QRã‚³ãƒ¼ãƒ‰ ğŸ‘‡</p>
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://hayaoshiquiz.onrender.com/student.html" alt="QR Code">
            <p style="font-size: 0.9rem; margin-top: 5px; color: #666;">https://hayaoshiquiz.onrender.com/student.html</p>
        </div>
        
        <h3 style="text-align: center; margin-top: 20px;">å‚åŠ ä¸­ã®ç”Ÿå¾’</h3>
        <div id="joined-users" style="text-align: center;">ã¾ã èª°ã‚‚ã„ã¾ã›ã‚“...</div>
        
        <button class="btn-start" onclick="startQuiz()">â–¶ ã‚¯ã‚¤ã‚ºã‚’ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h2 style="margin-top:0; color:#007bff;">âš™ï¸ è¨­å®š</h2>
            
            <div class="settings-group">
                <span>â­• æ­£è§£ã—ãŸæ™‚ã®åŸºæœ¬ç‚¹æ•°:</span>
                <span><input type="number" id="setting-base" value="10"> ç‚¹</span>
            </div>
            <div class="settings-group">
                <span>âš¡ æ—©ãç­”ãˆãŸ <input type="number" id="setting-count" value="1"> äººã«ã¯:</span>
                <span>+<input type="number" id="setting-bonus" value="5"> ç‚¹</span>
            </div>
            
            <div class="settings-group excel-group">
                <span style="font-weight: bold;">ğŸ“ å•é¡Œãƒ‡ãƒ¼ã‚¿ (Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ)</span>
                <span style="font-size: 0.85rem; color: #666;">â€»ç©ºæ¬„ã®å ´åˆã¯ã€Œå£é ­ã§ã®å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ã€ã«ãªã‚Šã¾ã™</span>
                <textarea id="quizData" rows="6" placeholder="apple&#9;ã‚Šã‚“ã”&#9;ã¿ã‹ã‚“&#9;ã°ãªãª&#9;ã¶ã©ã†&#9;1"></textarea>
            </div>

            <button class="btn btn-save" onclick="saveAndCloseSettings()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div id="quiz-screen" style="display: none;">
        <div class="header-info">
            <div class="score-settings-inline">
                ğŸ’¡ ä»Šå›ã®æ­£è§£: <input type="number" id="inline-base">ç‚¹<br>
                (å…ˆç€ <input type="number" id="inline-count">åã« +<input type="number" id="inline-bonus">ç‚¹)
            </div>
            <h1>Quiz</h1>
            <div>
                <div class="leader-title">ğŸ† Top 5</div>
                <div id="current-leaders">ã¾ã å¾—ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
        </div>
        
        <div class="question-box">
            <h2 id="teacher-q-num">ç¬¬ - å•</h2>
            <h3 id="teacher-q-text">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</h3>
        </div>

        <div class="controls">
            <button class="btn-reveal" onclick="revealNames()">ğŸ‘€ å›ç­”è€…åãƒã‚§ãƒƒã‚¯</button>
            <button class="btn-judge" onclick="autoJudge()">ğŸ¯ ç­”ãˆåˆã‚ã›</button>
            <button class="btn-reset" onclick="resetQuestion()">ğŸ”„ å›ç­”è€…ã‚¯ãƒªã‚¢</button>
            <button class="btn-next" onclick="nextQuestion()">â¡ï¸ æ¬¡ã®å•é¡Œã¸</button>
        </div>
        
        <div class="container">
            <div class="choice-box">
                <div class="choice-header bg-A" onclick="judgeChoice('A')">A</div>
                <div class="choice-text" id="teacher-text-A"></div>
                <ol id="list-A"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-B" onclick="judgeChoice('B')">B</div>
                <div class="choice-text" id="teacher-text-B"></div>
                <ol id="list-B"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-C" onclick="judgeChoice('C')">C</div>
                <div class="choice-text" id="teacher-text-C"></div>
                <ol id="list-C"></ol>
            </div>
            <div class="choice-box">
                <div class="choice-header bg-D" onclick="judgeChoice('D')">D</div>
                <div class="choice-text" id="teacher-text-D"></div>
                <ol id="list-D"></ol>
            </div>
        </div>

        <button class="btn-finish" onclick="finishQuiz()">ğŸ Finish this quiz</button>
    </div>

    <div id="correct-overlay">
        <div class="correct-text" id="correct-display-text">æ­£è§£ã¯ Aï¼</div>
        <button class="correct-close" onclick="closeOverlay()">ç”»é¢ã‚’æˆ»ã™</button>
    </div>

    <div id="results" style="display: none;">
        <h1>Final Results</h1>
        <div id="podium"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentAnswers = { A: [], B: [], C: [], D: [] };
        let isRevealed = false;
        let isJudged = false;
        let currentRanking = [];
        let currentCorrectAnswer = ""; 
        const choiceLetters = ["A", "B", "C", "D"];

        // ==========================================
        // éŸ³å£°å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ==========================================
        function playAudio(id) {
            const audioEl = document.getElementById(id);
            if(audioEl) {
                audioEl.currentTime = 0; 
                audioEl.play().catch(e => console.log(`[Audio] ${id} ã®å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ:`, e));
            }
        }

        // ==========================================
        // ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜æ©Ÿèƒ½ï¼ˆLocalStorageï¼‰
        // ==========================================
        document.addEventListener("DOMContentLoaded", () => {
            if(localStorage.getItem('quizData')) {
                document.getElementById('quizData').value = localStorage.getItem('quizData');
            }
            if(localStorage.getItem('settingBase')) {
                document.getElementById('setting-base').value = localStorage.getItem('settingBase');
            }
            if(localStorage.getItem('settingBonus')) {
                document.getElementById('setting-bonus').value = localStorage.getItem('settingBonus');
            }
            if(localStorage.getItem('settingCount')) {
                document.getElementById('setting-count').value = localStorage.getItem('settingCount');
            }
        });

        function saveLocalData() {
            localStorage.setItem('quizData', document.getElementById('quizData').value);
            localStorage.setItem('settingBase', document.getElementById('setting-base').value);
            localStorage.setItem('settingBonus', document.getElementById('setting-bonus').value);
            localStorage.setItem('settingCount', document.getElementById('setting-count').value);
        }

        // ==========================================
        // UIãƒ»ã‚¯ã‚¤ã‚ºé€²è¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ==========================================
        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function saveAndCloseSettings() {
            saveLocalData();
            document.getElementById('settings-modal').style.display = 'none';
        }

        socket.on('update_lobby', (names) => {
            const list = document.getElementById('joined-users');
            list.innerHTML = '';
            names.forEach(name => {
                list.innerHTML += `<span class="user-badge">${name}</span>`;
            });
        });

        function startQuiz() {
            saveLocalData(); 
            
            const bgm = document.getElementById('audio-bgm');
            if (bgm) {
                bgm.volume = 0.3;
                playAudio('audio-bgm');
            }

            const rawData = document.getElementById('quizData').value;
            const parsedQuestions = [];

            if (!rawData.trim()) {
                parsedQuestions.push({
                    question: "ã€ å£é ­å•é¡Œ ã€‘å…ˆç”Ÿã®è³ªå•ã‚’èã„ã¦ãã ã•ã„",
                    choices: ["", "", "", ""],
                    correctChoiceLetter: "" 
                });
            } else {
                const lines = rawData.trim().split('\n');
                for (let i = 0; i < lines.length; i++) {
                    const columns = lines[i].split('\t');
                    if (columns.length >= 6) {
                        const correctIndex = parseInt(columns[5].trim(), 10) - 1; 
                        parsedQuestions.push({
                            question: columns[0].trim(),
                            choices: [ columns[1].trim(), columns[2].trim(), columns[3].trim(), columns[4].trim() ],
                            correctChoiceLetter: choiceLetters[correctIndex]
                        });
                    }
                }
            }

            if (parsedQuestions.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");

            socket.emit('start_quiz_data', parsedQuestions);

            const base = document.getElementById('setting-base').value;
            const bonus = document.getElementById('setting-bonus').value;
            const count = document.getElementById('setting-count').value;
            
            socket.emit('update_settings', { basePoints: base, bonusPoints: bonus, bonusCount: count });
            
            document.getElementById('inline-base').value = base;
            document.getElementById('inline-bonus').value = bonus;
            document.getElementById('inline-count').value = count;
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('quiz-screen').style.display = 'block';
        }

        socket.on('new_question', (data) => {
            document.getElementById('teacher-q-num').innerText = `ç¬¬ ${data.questionNumber} å• / å…¨ ${data.totalQuestions} å•`;
            document.getElementById('teacher-q-text').innerText = data.question;
            currentCorrectAnswer = data.correctChoiceLetter || ""; 
            
            const letters = ['A', 'B', 'C', 'D'];
            data.choices.forEach((choice, index) => {
                document.getElementById(`teacher-text-${letters[index]}`).innerText = choice;
            });
        });

        socket.on('update_answers_teacher', (answers) => {
            currentAnswers = answers;
            renderAnswers();
        });

        function renderAnswers() {
            ['A', 'B', 'C', 'D'].forEach(choice => {
                const list = document.getElementById(`list-${choice}`);
                list.innerHTML = '';
                currentAnswers[choice].forEach((name) => {
                    const li = document.createElement('li');
                    li.textContent = isRevealed ? name : 'ğŸ”’ (å›ç­”æ¸ˆ)';
                    li.style.color = isRevealed ? '#333' : '#aaa';
                    list.appendChild(li);
                });
            });
        }

        function revealNames() {
            isRevealed = true;
            playAudio('audio-reveal');
            renderAnswers();
        }

        function autoJudge() {
            if (!currentCorrectAnswer) {
                alert("ã“ã®å•é¡Œã«ã¯æ­£è§£ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nAã€œDã®ãƒ‘ãƒãƒ«ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ­£è§£ã‚’ç™ºè¡¨ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            judgeChoice(currentCorrectAnswer);
        }

        function judgeChoice(choice) {
            if (isJudged) return; 
            isJudged = true;
            
            const currentBase = document.getElementById('inline-base').value;
            const currentBonus = document.getElementById('inline-bonus').value;
            const currentCount = document.getElementById('inline-count').value;

            socket.emit('judge_answer', { 
                choice: choice, 
                currentSettings: { basePoints: currentBase, bonusPoints: currentBonus, bonusCount: currentCount } 
            });

            playAudio('audio-correct');

            const overlay = document.getElementById('correct-overlay');
            const text = document.getElementById('correct-display-text');
            text.textContent = `æ­£è§£ã¯ ${choice} ï¼ï¼`;
            overlay.style.display = 'flex';
        }

        function closeOverlay() {
            document.getElementById('correct-overlay').style.display = 'none';
        }

        function resetQuestion() {
            socket.emit('reset_question');
            isRevealed = false;
            isJudged = false;
            playAudio('audio-reset');
        }

        function nextQuestion() {
            socket.emit('next_question');
            isRevealed = false;
            isJudged = false;
            playAudio('audio-reset');
        }

        socket.on('update_ranking', (ranking) => {
            currentRanking = ranking;
            const leadersDiv = document.getElementById('current-leaders');
            leadersDiv.innerHTML = '';
            
            if (ranking.length === 0) {
                leadersDiv.innerHTML = 'ã¾ã å¾—ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“';
                return;
            }
            
            let limit = Math.min(ranking.length, 5);
            for(let i = 0; i < limit; i++) {
                leadersDiv.innerHTML += `<div>${i+1}ä½: ${ranking[i].name} (${ranking[i].score}ç‚¹)</div>`;
            }
        });

        function finishQuiz() {
            if(!confirm('ã‚¯ã‚¤ã‚ºã‚’çµ‚äº†ã—ã¦çµæœç™ºè¡¨ã«ç§»ã‚Šã¾ã™ã‹ï¼Ÿ')) return;

            const bgm = document.getElementById('audio-bgm');
            if(bgm) bgm.pause();

            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            let top5 = currentRanking.slice(0, 5).reverse(); 
            let delay = 500; 
            
            if(top5.length === 0) {
                podium.innerHTML = '<h2>ã¾ã èª°ã‚‚å¾—ç‚¹ã—ã¦ã„ã¾ã›ã‚“...ï¼</h2>';
                return;
            }

            top5.forEach((player, index) => {
                setTimeout(() => {
                    let rank = top5.length - index;
                    let div = document.createElement('div');
                    div.className = 'rank-item';
                    if(rank === 1) div.classList.add('rank-1');
                    div.innerHTML = `ç¬¬ ${rank} ä½: ${player.name} <span style="color:#666; font-size:1rem;">(${player.score}ç‚¹)</span>`;
                    podium.prepend(div);
                    playAudio('audio-reveal');
                }, delay);
                delay += 1000;
            });
        }
    </script>
</body>
</html>
