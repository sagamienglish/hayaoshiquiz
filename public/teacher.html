<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ•™å“¡ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ç”»é¢</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: sans-serif; padding: 20px; background-color: #f0f2f5; }
  .container { background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 700px; margin: 0 auto; }
  .section { margin-bottom: 24px; }
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»ãƒœã‚¿ãƒ³é¡ */
  .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 12px; margin-bottom: 20px; }
  .header h2 { margin: 0; }
  .btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; border: none; color: white; }
  .btn-settings { background-color: #4CAF50; }
  .btn-primary { background-color: #2196F3; font-size: 16px; padding: 12px 24px;}
  .btn-danger { background-color: #f44336; }
  .btn-secondary { background-color: #9e9e9e; }
  .btn:hover { opacity: 0.9; }

  /* ã‚¹ã‚³ã‚¢è¨­å®š */
  .score-settings { display: flex; align-items: center; gap: 16px; background: #f9f9f9; padding: 12px; border-radius: 4px; border: 1px solid #e0e0e0; }
  .score-settings input { width: 60px; padding: 4px; margin-left: 4px; }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
  .modal-overlay.active { display: flex; }
  .settings-modal { background: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 700px; }
  .settings-modal textarea { width: 100%; height: 200px; margin-top: 12px; padding: 8px; font-family: monospace; white-space: pre; }
  
  /* ã‚¯ã‚¤ã‚ºé€²è¡Œç”»é¢ç”¨ */
  #quiz-control-screen { display: none; }
  .status-board { display: flex; gap: 20px; margin-bottom: 20px; }
  .status-box { background: #e3f2fd; padding: 15px; border-radius: 8px; flex: 1; text-align: center; font-size: 1.2em; font-weight: bold;}
  .ranking-box { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #ffe0b2;}
</style>
</head>
<body>

<div class="container" id="start-screen">
  <div class="header">
    <h2>Lesson 1 Vocabulary</h2>
    <button class="btn btn-settings" onclick="toggleModal('settingsModal')">âš™ï¸ å•é¡Œè¨­å®š</button>
  </div>

  <div class="section">
    <label><b>ã‚¹ã‚³ã‚¢ãƒ»ãƒœãƒ¼ãƒŠã‚¹è¨­å®š:</b></label>
    <div class="score-settings">
      <label>åŸºæœ¬ç‚¹: <input type="number" id="basePoints" value="10"></label>
      <label>æ—©æŠ¼ã—ãƒœãƒ¼ãƒŠã‚¹ç‚¹: <input type="number" id="bonusPoints" value="5"></label>
      <label>ãƒœãƒ¼ãƒŠã‚¹å¯¾è±¡äººæ•°: <input type="number" id="bonusCount" value="3"> äºº</label>
    </div>
  </div>

  <div class="section">
    <label><b>ç”Ÿå¾’ç”¨ã‚¢ã‚¯ã‚»ã‚¹QRã‚³ãƒ¼ãƒ‰:</b></label>
    <p style="font-size: 0.85em; color: #666; margin-top: 4px;">ï¼ˆç”Ÿå¾’ãŒã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã‚‰å³ä¸Šã®ã€Œå•é¡Œè¨­å®šã€ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ï¼‰</p>
    <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://localhost:3000/student.html" width="150" alt="QRã‚³ãƒ¼ãƒ‰">
    <br><br>
    <p>ç¾åœ¨ã®å‚åŠ è€…æ•°: <span id="lobby-count" style="font-weight:bold; color:blue;">0</span> äºº</p>
  </div>
</div>

<div class="container" id="quiz-control-screen">
  <div class="header">
    <h2 id="teacher-question-info">ç¬¬ - å•</h2>
    <button class="btn btn-danger" onclick="location.reload()">çµ‚äº†ã—ã¦æœ€åˆã«æˆ»ã‚‹</button>
  </div>
  
  <h3 id="teacher-question-text" style="color: #333;"></h3>
  <p style="color: red; font-weight: bold;">æ­£è§£: <span id="teacher-correct-answer"></span></p>

  <div class="status-board">
    <div class="status-box">A: <span id="count-A">0</span>äºº</div>
    <div class="status-box">B: <span id="count-B">0</span>äºº</div>
    <div class="status-box">C: <span id="count-C">0</span>äºº</div>
    <div class="status-box">D: <span id="count-D">0</span>äºº</div>
  </div>

  <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
    <button class="btn btn-primary" onclick="judgeAnswer()">ğŸ† æ­£è§£åˆ¤å®šï¼†ãƒã‚¤ãƒ³ãƒˆä»˜ä¸</button>
    <button class="btn btn-secondary" onclick="nextQuestion()">â¡ï¸ æ¬¡ã®å•é¡Œã¸</button>
  </div>

  <div class="ranking-box">
    <h3>ç¾åœ¨ã®ãƒˆãƒƒãƒ—3</h3>
    <ol id="ranking-list">
      <li>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
    </ol>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="settings-modal">
    <h3>å•é¡Œãƒ‡ãƒ¼ã‚¿ã®ç™»éŒ²</h3>
    <p style="font-size: 0.9em; color: #555;">Excelç­‰ã‹ã‚‰ã€Œå•é¡Œãƒ»é¸æŠè‚¢1ã€œ4ãƒ»æ­£è§£ç•ªå·(1ã€œ4)ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
    <textarea id="quizData" placeholder="apple&#9;ã‚Šã‚“ã”&#9;ã¿ã‹ã‚“&#9;ã°ãªãª&#9;ã¶ã©ã†&#9;1"></textarea>
    <div style="text-align: right; margin-top: 10px;">
      <button class="btn btn-secondary" onclick="toggleModal('settingsModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveAndStartQuiz()">ä¿å­˜ã—ã¦ã‚¯ã‚¤ã‚ºé–‹å§‹</button>
    </div>
  </div>
</div>

<script>
  const socket = io();
  const choiceLetters = ["A", "B", "C", "D"];
  let currentCorrectChoiceLetter = ""; // ç¾åœ¨ã®å•é¡Œã®æ­£è§£(A,B,C,D)

  // ãƒ­ãƒ“ãƒ¼ã®äººæ•°æ›´æ–°
  socket.on('update_lobby', (playersArr) => {
    document.getElementById('lobby-count').innerText = playersArr.length;
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
  function toggleModal(modalId) {
    document.getElementById(modalId).classList.toggle('active');
  }

  // Excelãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚¯ã‚¤ã‚ºã‚’é–‹å§‹
  function saveAndStartQuiz() {
    const rawData = document.getElementById('quizData').value;
    if (!rawData) return alert("ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");

    const lines = rawData.trim().split('\n');
    const parsedQuestions = [];

    for (let i = 0; i < lines.length; i++) {
      const columns = lines[i].split('\t');
      if (columns.length >= 6) {
        // 6åˆ—ç›®ï¼ˆæ­£è§£ç•ªå·1ã€œ4ï¼‰ã‚’ A,B,C,D ã«å¤‰æ›ã—ã¦ä¿å­˜
        const correctIndex = parseInt(columns[5].trim(), 10) - 1; 
        parsedQuestions.push({
          question: columns[0].trim(),
          choices: [ columns[1].trim(), columns[2].trim(), columns[3].trim(), columns[4].trim() ],
          correctChoiceLetter: choiceLetters[correctIndex] // "A", "B", "C", "D" ã®ã„ãšã‚Œã‹
        });
      }
    }

    if (parsedQuestions.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");

    // ã‚µãƒ¼ãƒãƒ¼ã¸å•é¡Œãƒªã‚¹ãƒˆã‚’é€ä¿¡
    socket.emit('start_quiz_data', parsedQuestions);
    
    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    toggleModal('settingsModal');
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('quiz-control-screen').style.display = 'block';
  }

  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã€Œç¾åœ¨ã®å•é¡Œã€ã‚’å—ã‘å–ã£ã¦æ•™å“¡ç”»é¢ã‚’æ›´æ–°
  socket.on('new_question', (data) => {
    document.getElementById('teacher-question-info').innerText = `ç¬¬ ${data.questionNumber} å• / å…¨ ${data.totalQuestions} å•`;
    document.getElementById('teacher-question-text').innerText = data.question;
    
    // æ­£è§£ã®æ–‡å­—(A/B/C/D)ã‚’ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§å—ã‘å–ã‚‹ã‹ã€ã“ã“ã§ç›´æ¥ä¿æŒã™ã‚‹ã‹ã§ã™ãŒã€
    // ä»Šå›ã¯å®‰å…¨ã®ãŸã‚ã€é€ä¿¡ã—ãŸå…ƒã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‚ç…§ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼æ”¹ä¿®æ¸ˆã¿ã®å‰æãªã‚‰dataå†…ã«å«ã‚ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ä»Šå›ã¯ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ï¼‰
    // ï¼ˆâ€»å®Œå…¨åŒæœŸã®ãŸã‚ã€ã‚µãƒ¼ãƒãƒ¼å´ã‹ã‚‰æ­£è§£ã‚‚é€ã‚Šè¿”ã—ã¦ã‚‚ã‚‰ã†ã‚ˆã† server.js ã‚’å°‘ã—ç›´ã™ã‹ã€æ•™å“¡å´ã®ãƒ¡ãƒ¢ãƒªã§ä¿æŒã—ã¾ã™ï¼‰
  });

  // æ•™å“¡å´ãŒé€ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä½¿ã£ã¦æ­£è§£ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ãƒ•ãƒƒã‚¯
  // ï¼ˆstart_quiz_dataã—ãŸã¨ãã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ã£ã¦ã‚‚ã‚ˆã„ã§ã™ãŒã€ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å®Ÿè£…ã—ã¾ã™ï¼‰
  // ã‚µãƒ¼ãƒãƒ¼å´ã® new_question ã« correctChoiceLetter ã‚‚è¿½åŠ ã—ã¦é€ã‚‹æƒ³å®šã§æ›¸ãã¾ã™ã€‚
  socket.on('new_question', (data) => {
    // ã‚‚ã—server.jsã§ correctChoiceLetter ã‚’é€ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚Œã°è¡¨ç¤ºã€‚
    // â€»é€ã£ã¦ã„ãªãã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚
    if(data.correctChoiceLetter) {
        currentCorrectChoiceLetter = data.correctChoiceLetter;
        document.getElementById('teacher-correct-answer').innerText = currentCorrectChoiceLetter;
    }
  });

  // ç”Ÿå¾’ã‹ã‚‰ã®è§£ç­”çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  socket.on('update_answers_teacher', (answers) => {
    document.getElementById('count-A').innerText = answers.A.length;
    document.getElementById('count-B').innerText = answers.B.length;
    document.getElementById('count-C').innerText = answers.C.length;
    document.getElementById('count-D').innerText = answers.D.length;
  });

  // æ­£è§£åˆ¤å®šãƒœã‚¿ãƒ³ï¼ˆã‚µãƒ¼ãƒãƒ¼ã¸ç¾åœ¨ã®è¨­å®šã¨æ­£è§£ã‚’é€ä¿¡ï¼‰
  function judgeAnswer() {
    if (!currentCorrectChoiceLetter) {
      // ä¸‡ãŒä¸€ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ­£è§£æ–‡å­—ãŒæ¥ã¦ã„ãªã„å ´åˆã¯ã€æ‰‹å‹•ã§å…¥åŠ›ã•ã›ã‚‹ï¼ˆãƒ•ã‚§ãƒ¼ãƒ«ã‚»ãƒ¼ãƒ•ï¼‰
      currentCorrectChoiceLetter = prompt("æ­£è§£ã®é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (A, B, C, D):").toUpperCase();
    }
    
    const settings = {
      basePoints: document.getElementById('basePoints').value,
      bonusPoints: document.getElementById('bonusPoints').value,
      bonusCount: document.getElementById('bonusCount').value
    };

    socket.emit('judge_answer', { 
      choice: currentCorrectChoiceLetter, 
      currentSettings: settings 
    });
    
    alert(`æ­£è§£ã€Œ${currentCorrectChoiceLetter}ã€ã§åˆ¤å®šã—ã€ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã—ã¾ã—ãŸï¼`);
  }

  // æ¬¡ã®å•é¡Œã¸ãƒœã‚¿ãƒ³
  function nextQuestion() {
    socket.emit('next_question');
  }

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
  socket.on('update_ranking', (rankingArr) => {
    const list = document.getElementById('ranking-list');
    list.innerHTML = "";
    // ãƒˆãƒƒãƒ—3ã ã‘è¡¨ç¤º
    rankingArr.slice(0, 3).forEach((player, index) => {
      const li = document.createElement('li');
      li.innerText = `${player.name} (${player.score}ç‚¹)`;
      list.appendChild(li);
    });
  });

  // å…¨å•çµ‚äº†
  socket.on('quiz_finished', () => {
    alert("å…¨å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸï¼");
    document.getElementById('teacher-question-info').innerText = "çµæœç™ºè¡¨ï¼";
  });
</script>

</body>
</html>
